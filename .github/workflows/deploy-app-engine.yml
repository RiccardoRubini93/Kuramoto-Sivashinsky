name: Deploy to App Engine

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'standard'
        type: choice
        options:
          - standard
          - flexible

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

jobs:
  deploy:
    name: Deploy to App Engine
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Create app.yaml for standard environment
        if: github.event.inputs.environment == 'standard'
        run: |
          cat > app.yaml << EOF
          runtime: python311
          instance_class: F2
          
          entrypoint: gunicorn --bind :$PORT --workers 1 --threads 4 --timeout 120 wsgi:server
          
          env_variables:
            PORT: 8080
            HOST: 0.0.0.0
          
          automatic_scaling:
            min_instances: 0
            max_instances: 10
            target_cpu_utilization: 0.65
          EOF
      
      - name: Create app.yaml for flexible environment
        if: github.event.inputs.environment == 'flexible'
        run: |
          cat > app.yaml << EOF
          runtime: custom
          env: flex
          
          env_variables:
            PORT: 8080
            HOST: 0.0.0.0
          
          automatic_scaling:
            min_num_instances: 1
            max_num_instances: 10
            cpu_utilization:
              target_utilization: 0.65
          
          resources:
            cpu: 2
            memory_gb: 2
            disk_size_gb: 10
          EOF
      
      - name: Deploy to App Engine
        run: |
          gcloud app deploy --quiet --project=${{ env.PROJECT_ID }}
      
      - name: Get Service URL
        run: |
          echo "Service deployed successfully!"
          gcloud app describe --project=${{ env.PROJECT_ID }} --format='value(defaultHostname)'
